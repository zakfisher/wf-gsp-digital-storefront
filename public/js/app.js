App = {
    cache: {
        completed: {
            events: false,
            movies: false,
            stores: false
        },
        services: [
            {
                name: 'Free Wifi',
                img: 'http://res.cloudinary.com/wlabs/image/asset/f_auto,w_800,q_100/free-wifi-dd9d7f79667efb25dddc9b139d4a7425',
                desc: '<p>Surf while you shop at Westfield Garden State Plaza with our free WiFi service. Wherever you are at Westfield Garden State Plaza, you have the ability to connect to the internet via WiFi for free. To take advantage of our super-fast service, simply access the internet from your laptop or phone as normal and follow the on-screen prompts. All services subject to availability. Terms and conditions apply.</p>'
            },
            {
                name: 'Answers on the Spot',
                img: 'http://res.cloudinary.com/wlabs/image/asset/f_auto,w_800,q_100/answers-on-the-spot-f3ad2f62e64f369ae60b5946419868b6',
                desc: '<p>Not sure where a store is located? Want to know the price of an item? Need assistance with a wheelchair? Introducing Answers on the Spot, new service provided by Westfield Garden State Plaza.</p><p>Text the number 201.957.7655 with your mall questions and get an instant response from Westfield Garden State Plaza.</p>'
            },
            {
                name: 'ATMs',
                img: 'http://res.cloudinary.com/wlabs/image/asset/f_auto,w_800,q_100/atms-ed4ee2e5ee94affb2e518dcd5c9a9cdc',
                desc: '<p>If you\'re short on shopping cash or need to check your account balance, stop at one of our safe, convenient ATMs at the following locations:</p><h4>Level 1</h4><ul><li>Food Court</li><li>Corridor Near Cinnabon</li></ul><h4>Level 2</h4><ul><li>Bank of America (Entrance #5)</li><li>Corridor near Sydney Thomas</li><li>Entrance 2 (Near Ruby Tuesday)</li></ul>'
            },
            {
                name: 'Foreign Currency Exchange',
                img: 'http://res.cloudinary.com/wlabs/image/asset/f_auto,w_800,q_100/foreign-currency-7a283fdf4bc9b0ae626f499f3b78a48c',
                desc: '<p>Travelex is located on the lower level near Lord &amp; Taylor. They supply and buy more than 100 foreign exchange currencies. The retail branch also offers a wide range of travel and financial products, such as travel insurance and phone cards.</p><p>Please call Travelex for all your travel needs at 201.845.4141.</p>'
            },
            {
                name: 'Custom Gift Wrap',
                img: 'http://res.cloudinary.com/wlabs/image/asset/f_auto,w_800,q_100/custom-gift-wrap-0069d04f4a0af2e884b794a674a5853c',
                desc: '<p>Get your gifts beautifully wrapped at the following locations. Fees may apply.</p><ul><li>Papyrus located near Nordstrom on the Lower Level 201.291.1822</li><li>Macy’s located on the East side of the Center 201.843.9100</li><li>Nordstrom located on the North side of the Center 201.843.1122</li></ul>'
            },
            {
                name: 'Westfield Family Lounge',
                img: 'http://res.cloudinary.com/wlabs/image/asset/f_auto,w_800,q_100/6.5-3_us-3d4110e4d453009b38a84ff0df9b3eb0',
                desc: '<p>The two exclusive family lounges include: private nursing areas, baby changing-stations, bottle warmers, child-friendly bathrooms and a comfortable rest area with televisions airing children\'s programming. Both lounges are located on the lower level at the Food Court and by Cinnabon.</p>'
            },
            {
                name: 'Westfield PlaySpace',
                img: 'http://res.cloudinary.com/wlabs/image/asset/f_auto,w_800,q_100/Playspace-20fbaa5f091bec63c4c188501fb99bca',
                desc: '<p>A fun place for children to learn and play is the Westfield PlaySpace. Kids can climb and explore the bright, colorful play area.</p><p>The Westfield Family PlaySpace is located in the Food Court on the Lower Level. Children are required to be supervised by an adult at all times.</p>'
            },
            {
                name: 'Westfield Kid-Friendly Dining',
                img: 'http://res.cloudinary.com/wlabs/image/asset/f_auto,w_800,q_100/6.5-4_us-e89c7342e816ff4115b0ba30a922d10c',
                desc: '<p>Several restaurants at Westfield Garden State Plaza cater to children with special menus and activities designed to keep the young ones happy.</p><ul><li>California Pizza Kitchen</li><li>Johnny Rockets</li><li>Nordstrom Café</li><li>Ruby Tuesday</li><li>Grand Lux Café</li></ul>'
            },
            {
                name: 'Expectant Mother Parking',
                img: 'http://res.cloudinary.com/wlabs/image/asset/f_auto,w_800,q_100/FamilyParking-4266874219584379e03c9995ea387801',
                desc: '<p>Take advantage of preferred, up-front parking spaces close to the center entrances just for moms-to-be. Look for “Expectant Mother Parking” signs designating special parking spaces.</p>'
            },
            {
                name: 'Westfield Family Events',
                img: 'http://res.cloudinary.com/wlabs/image/asset/f_auto,w_800,q_100/FamilyEvents-c2a28013f2accf8171b5ae8c00b30679',
                desc: '<p>Play, shop, eat - find fun events, ideas and offers for the whole family!</p>'
            },
            {
                name: 'Lost and Found',
                img: 'http://res.cloudinary.com/wlabs/image/asset/f_auto,w_800,q_100/lost-and-found-276633453540058849b3bbaba270e4b8',
                desc: '<p>Misplaced an item during your visit? Please contact Westfield Security Team at 201.368.0748 for immediate assistance.</p>'
            },
            {
                name: 'Smarte Carte&reg; Strollers',
                img: 'http://res.cloudinary.com/wlabs/image/asset/f_auto,w_800,q_100/smarte-cart-e7e4f7b22fb9edd90e26ea8e704cceb6',
                desc: '<p>Visiting us with kids in tow? Try a Smarte Carte stroller! Little ones will love riding in these colorful vehicles, and you’ll love keeping them close while you shop.</p><p>Smarte Carte strollers feature:</p><ul><li>Plenty of space for personal items and purchases</li><li>Two convenient cup holders and a snack tray</li><li>A moving steering wheel to keep little hands occupied</li><li>Lap safety belt</li></ul><p>Self-serve strollers are available at the following locations:</p><h4>Double Strollers</h4><ul><li>Entrance #3 by Coffee Bean &amp; Tea Leaf</li></ul><h4>Single Strollers</h4><ul><li>Food Court Entrance Between Neiman Marcus and Macy\'s near the restroom</li></ul>'
            },
            {
                name: 'Employment',
                img: 'http://res.cloudinary.com/wlabs/image/asset/f_auto,w_800,q_100/6.5-10_us-47731f7c0e11fc75b158e9fae449f65f',
                desc: '<p>Join the world-class team of Westfield or one of Westfield Garden State Plaza\'s department stores, restaurants or specialty shops.</p>'
            }
        ]
    },
    cacheTools: {
        checkStatus: function() {
            var complete = (App.cache.completed.centreHours && App.cache.completed.events && App.cache.completed.movies && App.cache.completed.stores);
            if (App.loading == 'Cache' && complete) {
                console.log('cache', App.cache);
                App.message('Check JS console for cache object.', 'Cache Finished');
                App.cacheTools.save();
            }
        },
        getFromLocal: function() {
            // Check if local cache exists
            if (localStorage.digitalStorefrontLastCached) {
                var lastCacheDate = localStorage.digitalStorefrontLastCached;
                // Use local cache if valid
                if (localStorage.digitalStorefrontLastCached == App.date) {
                    App.cache = JSON.parse(localStorage.digitalStorefrontCache);
                    console.log('local cache', App.cache);
                }
                // If local cache is invalid, wipe it
                else {
                    console.log('clear cache')
                    localStorage.clear();
                }
            }
        },
        save: function() {
            console.log('Cache object complete.');
            localStorage.setItem('digitalStorefrontLastCached', App.date);
            localStorage.setItem('digitalStorefrontCache', JSON.stringify(App.cache));
        }
    },
    centre: {
        id: 'gardenstateplaza',
        name: 'Garden State Plaza',
        theatreId: 9312
    },
    date: (function() {
        var m = new moment();
        return m.format('YYYY-MM-DD');
    })(),
    formatRuntime: function(runtime) {
        // FROM: PT01H45M
        // TO: 01 hr 45 min
        var hour = parseInt(runtime.substr(2, 2));
        var minute = parseInt(runtime.substr(5, 2));
        return hour + ' hr ' + minute + ' min';
    },
    formatSchedule: function(start, end) {
        var s = new moment(start);
        var e = new moment(end);
        // OCT 17 FRIDAY 10:00am - 9:00pm
        return (s.format('MMM D dddd h:mmA') + ' - ' + e.format('h:mmA')).toUpperCase();
    },
    formatStoreHours: function(store) {
        if (App.cache.centreHours == 'Closed today.') {
            return 'Closed';
        }
        var s = new moment(store.hours.date + ' ' + store.hours.opening_time);
        var e = new moment(store.hours.date + ' ' + store.hours.closing_time);
        // 10:00am - 9:00pm
        return s.format('h:mmA') + ' - ' + e.format('h:mmA');
    },
    load: function(page) {
        if (page != 'Loading') {
            App.loading = page;
        }
        if (page != 'Stores' && page != 'Error') {
            $('header .filter').remove();
        }
        App.render('Loading', '#template-loading-page', {});
    },
    render: function(page, template, data) {
        $('main').attr('data-page', page).html(_.template($(template).html(), data));
    },
    error: function(message, page, disclaimer) {
        App.Views.header.render(page, disclaimer);
        App.render('Error', '#template-error', { 
            page: page,
            message: message 
        });
    },
    message: function(message, page, disclaimer) {
        App.Views.header.render(page, disclaimer);
        App.render('Message', '#template-message', { 
            page: page,
            message: message 
        });
    }
};

App.Collections = {
    Deals: Backbone.Collection.extend({
        url: '/deal/master/deals.json?centre=' + App.centre.id + '&state=live',
        cache: function(deals, cb) {
            console.log('api - deals');
            // Fetch retailer for each deal
            var retailersFetched = 0;
            $(deals.models).each(function(i, deal) {
                var retailerId = deal.get('deal_stores')[0].retailer_id;
                deal.Retailer = new App.Models.Retailer();
                deal.Retailer.urlRoot += retailerId + '.json';
                deal.Retailer.fetch({
                    success: function(retailer) {
                        retailersFetched++;
                        deal.set('retailer', retailer);
                        // Render once all retailers are cached
                        if (retailersFetched == deals.models.length) {
                            App.cache.deals = JSON.parse(JSON.stringify(deals.models));
                            cb();
                        }
                    },
                    error: function (model, response) {
                        App.error('Unable to fetch retailers.', 'Deals & Offers');
                    }
                });
            });
        }
    }),
    Events: Backbone.Collection.extend({
        url: '/event/master/events.json?centre=' + App.centre.id + '&country=us&published=true',
        cache: function(events, cb) {
            console.log('api - events');
            // Sort events by end date
            events.models = events.models.sort(function(a, b) {
                a = a.get('occurrences')[a.get('occurrences').length -1].start;
                b = b.get('occurrences')[b.get('occurrences').length -1].start;
                if (a > b) return 1;
                if (a < b) return -1;
                return 0;
            });
            // Format event schedule for each event
            $(events.models).each(function(i, event) {
                var schedule = {};
                $(event.get('occurrences')).each(function(j, occurrence) {
                    var start = new moment(occurrence.start);
                    var end = new moment(occurrence.finish);
                    schedule[start.format('MMM D')] = {
                        day: start.format('dddd'),
                        startTime: start.format('h:mmA'),
                        endTime: end.format('h:mmA')
                    };
                });
                event.set('schedule', schedule);
            });
            App.cache.events = JSON.parse(JSON.stringify(events.models));
            App.cache.completed.events = true;
            cb();
        }
    }),
    Hours: Backbone.Collection.extend({
        url: '/trading-hour/master/centre_trading_hours/range.json?centre_id=gardenstateplaza&from=' + App.date + '&to=' + App.date
    }),
    Movies: Backbone.Collection.extend({
        url: 'http://data.tmsapi.com/v1/theatres/' + App.centre.theatreId + '/showings?api_key=khdmmearvwdhrskchcatf9vb&numDays=7&numDays=7&startDate=' + App.date,
        cache: function(movies, cb) {
            // Sort showtimes and Fetch trailers for each movie
            var trailersFetched = 0;
            $(movies.models).each(function(i, movie) {
                // Sort showtimes
                var showtimes = {};
                $(movie.get('showtimes')).each(function(i, showtime) {
                    var m = new moment(showtime.dateTime);
                    var date = m.format('MMM D');
                    if (!showtimes.hasOwnProperty(date)) {
                        showtimes[date] = {
                            day: m.format('dddd'),
                            times: [m.format('h:mmA')]
                        };
                    }
                    else {
                        showtimes[date].times.push(m.format('h:mmA'));
                    }
                });
                movie.set('showtimes', showtimes);
                // Fetch trailers
                var rootId = movie.get('rootId');
                movie.Trailer = new App.Models.Trailer();
                movie.Trailer.urlRoot += rootId;
                movie.Trailer.fetch({
                    success: function(trailer) {
                        trailersFetched++;
                        movie.set('trailer', trailer);
                        // Render once all trailers are cached
                        if (trailersFetched == movies.models.length) {
                            App.cache.movies = JSON.parse(JSON.stringify(movies.models));
                            App.cache.completed.movies = true;
                            console.log('api - movies');
                            cb();
                        }
                    },
                    error: function (model, response) {
                        App.error('Unable to fetch trailers.', 'Now Playing at AMC Theaters', 'Tickets available through the Westfield app, available on the iTunes store.');
                    }
                });
            });
        }
    }),
    Stores: Backbone.Collection.extend({
        url: '/store/master/stores.json?centre_id=' + App.centre.id + '&sort=name&sort_dir=asc&per_page=1000',
        cache: function(stores, cb) {
            var getStoreHours = function(storeId) {
                var storeHoursObj = {};
                $(App.cache.storeHours).each(function(i, obj) {
                    if (parseInt(obj.store_id) == storeId) {
                        storeHoursObj = obj;
                        return;
                    }
                });
                return storeHoursObj;
            };

            // Get deals
            var deals = {};
            $(App.cache.deals).each(function(i, deal) {
                $(deal.deal_stores).each(function(j, obj) {
                    if (deals.hasOwnProperty(obj.store_service_id)) deals[obj.store_service_id].push(obj);
                    else deals[obj.store_service_id] = [obj];
                });
            });
            var retailersFetched = 0;
            $(stores.models).each(function(i, store) {
                var storeDeals = deals[store.get('id')] || [];
                store.set('deals', storeDeals);
                // Get categories
                var categories = [];
                $(store.get('category_codes')).each(function(i, code) {
                    var category = App.cache.categoryMap[code];
                    categories.push(category.name);
                });
                store.set('categories', categories);
                // Get store hours
                if (App.cache.centreHours == 'Closed today.') {
                    store.set('hours', 'Closed');
                }
                else {
                    store.set('hours', getStoreHours(store.get('id')));
                }
                // Get retailer
                var retailerId = store.get('retailer_id');
                store.Retailer = new App.Models.Retailer();
                store.Retailer.urlRoot += retailerId + '.json';
                store.Retailer.fetch({
                    success: function(retailer) {
                        retailersFetched++;
                        var hasLogo = (typeof retailer.get('logo_ref') !== 'undefined');
                        if (hasLogo) {
                            hasLogo = (retailer.get('logo_ref') !== null && retailer.get('logo_ref').length > 0);
                        }
                        retailer.set('hasLogo', hasLogo);
                        store.set('retailer', retailer);
                        if (retailersFetched == stores.models.length) {
                            App.cache.stores = JSON.parse(JSON.stringify(stores.models));
                            App.cache.completed.stores = true;
                            console.log('api - stores');
                            cb();
                        }
                    },
                    error: function(model, response) {
                        App.error('Unable to fetch retailers.', 'Stores');
                    }
                });
            });
        }
    }),
    Categories: Backbone.Collection.extend({
        url: '/category/master/categories.json?centre_id=' + App.centre.id,
        cache: function(categories, cb) {
            console.log('api - categories');
            var categoryMap = {};
            $(categories.models).each(function(i, category) {
                category.name = category.get('name');
                categoryMap[category.get('code')] = category;
                if (category.get('children').length > 0) {
                    $(category.get('children')).each(function(j, subCategory) {
                        categoryMap[subCategory.code] = subCategory;
                    });
                }
            });
            // Contains only parent-level categories
            App.cache.categories = JSON.parse(JSON.stringify(categories.models));
            // Contains all categories
            App.cache.categoryMap = categoryMap;
            cb();
        }
    }),
    StoreHours: Backbone.Collection.extend({
        url: '/trading-hour/master/store_trading_hours/range.json?centre_id=' + App.centre.id + '&from=' + App.date + '&to=' + App.date,
        cache: function(storeHours, cb) {
            console.log('api - store hours');
            App.cache.storeHours = storeHours;
            cb();
        }
    })
};
App.Collections.categories = new App.Collections.Categories;
App.Collections.deals = new App.Collections.Deals;
App.Collections.events = new App.Collections.Events;
App.Collections.hours = new App.Collections.Hours;
App.Collections.movies = new App.Collections.Movies;
App.Collections.stores = new App.Collections.Stores;
App.Collections.storeHours = new App.Collections.StoreHours;

App.Models = {
    Retailer: Backbone.Model.extend({
        urlRoot: '/store/master/retailers/'
    }),
    Trailer: Backbone.Model.extend({
        urlRoot: 'http://data.tmsapi.com/v1/screenplayTrailers?api_key=khdmmearvwdhrskchcatf9vb&player_url=0&trailersonly=1&rootids='
    })
};

App.Views = {
    Deals: Backbone.View.extend({
        render: function() {
            var render = function() {
                var deals = App.cache.deals;
                if (App.loading != 'Deals') return;
                if (deals.length > 0) {
                    App.render('Deals', '#template-deal-list', {});
                }
                else {
                    App.error('No deals found.', 'Deals & Offers');
                }
            };

            // Render with cached data
            if (App.cache.hasOwnProperty('deals')) {
                console.log('cache - deals');
                render();
                return;
            }

            // Fetch all deals
            App.Collections.deals.fetch({
                success: function(deals) {
                    App.Collections.deals.cache(deals, render);
                },
                error: function(collection, response) {
                    App.error('Unable to fetch deals.', 'Deals & Offers');
                }
            });
        }
    }),
    Events: Backbone.View.extend({
        render: function() {
            var render = function() {
                var events = App.cache.events;
                App.cacheTools.checkStatus();
                if (App.loading != 'Events') return;
                if (events.length > 0) {
                    App.render('Events', '#template-event-list', {});
                }
                else {
                    App.error('No events are happening today.', 'Upcoming Events');
                }
            };

            // Render with cached data
            if (App.cache.hasOwnProperty('events')) {
                console.log('cache - events');
                render();
                return;
            }

            // Fetch new data
            App.Collections.events.fetch({
                success: function(events) {
                    App.Collections.events.cache(events, render);
                },
                error: function(collection, response) {
                    App.error('Unable to fetch events.', 'Upcoming Events');
                }
            });
        }
    }),
    Filter: Backbone.View.extend({
        el: 'header',
        events: {
            'click .select-wrapper': 'toggleMenuDisplay',
            'click .select-wrapper ul li': 'selectCategory',
            'click .deal-toggle-btn': 'toggleDealFilter'
        },
        filter: function() {
            window.scrollTo(0,0);

            // Remove error message
            if ($('main.error').length > 0) {
                $('main.error').remove();
                $('main').show();
            }

            // Reset all results
            $('article').hide().removeClass('visible');
            var query = 'article';
            var selects = $('header .filter .select-wrapper');
            
            // Always get code from last select
            var selectIndex = selects.length - 1;
            var select = selects[selectIndex];
            var code = $(select).find('p').attr('data-code');
            if (code !== '*') {
                query += '[data-categories*=' + code + ']';
            }

            // Apply Category Filter
            $(query).show().addClass('visible');

            // Apply Deal Filter
            if ($('div.deal-toggle-btn').attr('data-show') == 'deals') {
                $('article:not([deals])').hide().removeClass('visible');
            }

            // Show Error if no results
            if ($('article.visible').length == 0) {
                $('main').hide().after('<main class="error" data-page="Error"></main>');
                $('main.error').html(_.template($('#template-error').html(), { 
                    page: 'Stores',
                    message: 'No stores found.' 
                }));
            }
        },
        toggleMenuDisplay: function(e) {
            if ($(e.currentTarget).find('ul').is('.open')) {
                $(e.currentTarget).find('ul').removeClass('open');
                return;
            }
            $(e.currentTarget).find('ul').addClass('open');
        },
        selectCategory: function(e) {
            // Hide menu
            $(e.currentTarget).find('ul').removeClass('open');
            
            // Set current option values
            var code = $(e.currentTarget).attr('data-code');
            $(e.currentTarget).parents('.select-wrapper').find('p')
                .text($(e.currentTarget).text())
                .attr('data-code', code);

            // If this is a sub category, don't render selects
            var isSubCategory = $(e.currentTarget).parents('.col-33:nth-child(2)').length > 0;
            if (isSubCategory) {
                this.filter();
                return;
            }

            /* From here on, it can only be a parent category */

            // Check if category has sub-categories
            var category = App.cache.categoryMap[code];
            var subCategoriesExist = $(e.currentTarget).is('[subcategories]');
            var subCategories = [];
            if (subCategoriesExist) {
                subCategories = category.children || category.get('children');
            }
            console.log(subCategories);

            // If currently showing one category select
            if ($('header .filter div.col-50').length > 0) {
                // Add 2nd select
                if (subCategoriesExist) {
                    $('header .filter .col-50:nth-child(1)').after(_.template($('#template-store-sub-filter').html(), {
                        parentCode: code,
                        subCategories: subCategories
                    }));
                    $('header .filter div.col-50').addClass('col-33').removeClass('col-50');
                }
            }

            // If currently showing two category selects
            if ($('header .filter div.col-33').length > 0) {
                // Remove 2nd select
                if (!subCategoriesExist) {
                    $('header .filter .col-33:nth-child(2)').remove();
                    $('header .filter div.col-33').addClass('col-50').removeClass('col-33');
                }
                // Update 2nd select w/ new sub categories
                else {
                    var col = $('header .filter .col-33:nth-child(2)');
                    col.find('p').attr('data-code', code).text('Choose Sub Category');
                    col.find('ul').html('').append('<li data-code="' + code + '">All Sub Categories</li>');
                    $(subCategories).each(function(i, subCategory) {
                        col.find('ul').append('<li data-code="' + subCategory.code + '">' + subCategory.name + '</li>');
                    });
                }
            }

            this.filter();
        },
        toggleDealFilter: function(e) {
            if ($(e.currentTarget).attr('data-show') == 'deals') {
                $(e.currentTarget).attr('data-show', 'all');
            }
            else {
                $(e.currentTarget).attr('data-show', 'deals');
            }
            this.filter();
        }
    }),
    Header: Backbone.View.extend({
        render: function(title, disclaimer) {
            var defaultDisclaimer = 'Access this and and more information using the Westfield app or website.';
            $('title').html('Westfield ' + App.centre.name + ' ' + title);
            $('header h2').html(title);
            if (typeof disclaimer !== 'undefined') {
                defaultDisclaimer = disclaimer;
            }
            $('header p.disclaimer').html(defaultDisclaimer);
        },
        renderCentreInfo: function() {
            $('header h1').html(App.centre.name);

            // Render from cache
            if (App.cache.hasOwnProperty('centreHours')) {
                $('header p.hours').html(App.cache.centreHours);
                return;
            }

            // Fetch new centre
            App.Collections.hours.fetch({
                success: function(hours) {
                    console.log('api - centre hours');
                    console.log(hours.models);
                    var range;
                    if (hours.at(0).get('closed')) {
                        range = 'Closed today.';
                    }
                    else {
                        var open = hours.at(0).get('opening_time');
                        var close = hours.at(0).get('closing_time');
                        var openHour = parseInt(open.substr(0, 2));
                        var closeHour = parseInt(close.substr(0, 2));
                        if (openHour < 12) open += 'am';
                        else open += 'pm';
                        if (closeHour > 12) {
                            closeHour -= 12;
                            close = closeHour + close.substr(2) + 'pm';
                        }
                        else if (closeHour == 12) {
                            close += 'pm';
                        }
                        else {
                            close += 'am';
                        }    
                        range = 'Today\'s Hours: ' + open + ' - ' + close;
                    }
                    $('header p.hours').html(range);
                    App.cache.centreHours = range;
                    App.cache.completed.centreHours = true;
                    App.cacheTools.checkStatus();
                },
                error: function(collection, response) {
                    console.log('Unable to fetch hours.');
                }
            });
        }
    }),
    Movies: Backbone.View.extend({
        el: 'main',
        events: {
            'click div.video': 'playTrailer'
        },
        playTrailer: function(e) {
            if ($(e.currentTarget).is('.none')) return;
            var index = $(e.currentTarget).parents('article').attr('data-index');
            var movie = App.Collections.movies.at(index);
            $(e.currentTarget).html(_.template($('#template-movie-trailer').html(), {
                trailers: movie.trailer.get('response').trailers
            }));
        },
        render: function() {
            var render = function(movies) {
                var movies = App.cache.movies;
                App.cacheTools.checkStatus();
                if (App.loading != 'Movies') return;
                if (movies.length > 0) {
                    App.render('Movies', '#template-movie-list', {});
                }
                else {
                    App.error('No movies found.', 'Now Playing at AMC Theaters', 'Tickets available through the Westfield app, available on the iTunes store.');
                }
            };

            // Render with cached data
            if (App.cache.hasOwnProperty('movies')) {
                console.log('cache - movies');
                render();
                return;
            }

            // Fetch all movies
            App.Collections.movies.fetch({
                success: function(movies) {
                    App.Collections.movies.cache(movies, render);
                },
                error: function(collection, response) {
                    App.error('Unable to fetch movies.', 'Now Playing at AMC Theaters', 'Tickets available through the Westfield app, available on the iTunes store.');
                }
            });
        }
    }),
    Services: Backbone.View.extend({
        render: function() {
            App.render('Services', '#template-service-list', {
                services: App.cache.services
            });
        }
    }),
    Stores: Backbone.View.extend({
        render: function() {
            var render, fetchAllDeals, fetchAllCategories, fetchAllStoreHours, fetchAllStores;

            fetchAllDeals = function() {
                App.Collections.deals.fetch({
                    success: function(deals) {
                        App.Collections.deals.cache(deals, fetchAllCategories);
                    },
                    error: function(collection, response) {
                        App.error('Unable to fetch deals.', 'Error');
                    }
                });
            };

            fetchAllCategories = function() {
                App.Collections.categories.fetch({
                    success: function(categories) {
                        App.Collections.categories.cache(categories, fetchAllStoreHours);
                    },
                    error: function(collection, response) {
                        App.error('Unable to fetch categories.', 'Error');
                    }
                });
            };

            fetchAllStoreHours = function() {
                if (App.cache.centreHours == 'Closed today.') {
                    App.Collections.storeHours.cache([], fetchAllStores);
                    return;
                }
                $.get(App.Collections.storeHours.url, function(storeHours) {
                    App.Collections.storeHours.cache(storeHours, fetchAllStores);
                }).error(function() {
                    App.error('Unable to fetch store hours.', 'Error');
                });
            };

            fetchAllStores = function() {
                App.Collections.stores.fetch({
                    success: function(stores) {
                        App.Collections.stores.cache(stores, render);
                    },
                    error: function(collection, response) {
                        App.error('Unable to fetch stores.', 'Error');
                    }
                });
            };

            render = function() {
                var stores = App.cache.stores;
                App.cacheTools.checkStatus();
                if (App.loading != 'Stores') return;
                if (stores.length > 0) {
                    App.render('Stores', '#template-store-list', {});
                    if ($('header .filter').length == 0) {
                        $('header .disclaimer').before(_.template($('#template-store-filter').html(), {}));
                    }
                }
                else {
                    App.error('No stores found.', 'Error');
                }
            };

            // Render with cached data
            if (App.cache.hasOwnProperty('stores')) {
                console.log('cache - stores');
                render();
                return;
            }

            // Fetch all deals, all categories, all store hours, and all stores
            if (!App.cache.hasOwnProperty('deals')) fetchAllDeals();
            else fetchAllCategories();
        }
    })
};
App.Views.deals = new App.Views.Deals;
App.Views.events = new App.Views.Events;
App.Views.filter = new App.Views.Filter;
App.Views.header = new App.Views.Header;
App.Views.movies = new App.Views.Movies;
App.Views.services = new App.Views.Services;
App.Views.stores = new App.Views.Stores;

App.Router = Backbone.Router.extend({
    routes: {
        'cache'    : 'cache',
        'deals'    : 'deals',
        'events'   : 'events',
        'movies'   : 'movies',
        'services' : 'services',
        'stores'   : 'stores'
    },
    initialize: function() {
        App.cacheTools.getFromLocal();
        //console.log = function() {};
        App.Views.header.renderCentreInfo();
        // Use pushState without triggering a refresh
        Backbone.history.start({pushState: true});
        $(document).on('click', 'a[data-bypass]', function(e) {
            e.preventDefault();
            App.router.navigate($(e.currentTarget).attr('href'), true);
        });
        // Event listener for collapsible content
        $(document).on('click', '.toggle', function(e) {
            var content = $(e.currentTarget).parents('article').find('.toggle-content');
            if (content.is('.open')) content.removeClass('open');
            else content.addClass('open');
        });
    },
    cache: function() {
        // Cache not complete
        if (!(App.cache.completed.centreHours && App.cache.completed.events && App.cache.completed.movies && App.cache.completed.stores)) {
            App.Views.header.render('Building Caches...');
            App.Views.events.render();
            App.Views.movies.render();
            App.Views.stores.render();
            App.load('Cache');
        }
        // Cache already complete
        else {
            App.load('Cache');
            App.cacheTools.checkStatus();
        }
    },
    deals: function() {
        App.load('Deals');
        App.Views.header.render('Deals & Offers');
        App.Views.deals.render();
    },
    events: function() {
        App.load('Events');
        App.Views.header.render('Upcoming Events');
        App.Views.events.render();
    },
    movies: function() {
        App.load('Movies');
        App.Views.header.render('Now Playing at AMC Theaters', 'Tickets available through the Westfield app, available on the iTunes store.');
        App.Views.movies.render();
    },
    services: function() {
        App.load('Services');
        App.Views.header.render('Center Services');
        App.Views.services.render();
    },
    stores: function() {
        App.load('Stores');
        App.Views.header.render('Stores');
        App.Views.stores.render();
    }
});

// Auto-prefix Westfield API calls
$.ajaxPrefilter( function( options, originalOptions, jqXHR ) {
    options.crossDomain = true;
    if (options.url.indexOf('http') == -1) {
        options.url = 'http://api.westfield.io/api' + options.url;
    }
});

// Underscore templating syntax = {{ }}, {{= }}
_.templateSettings = {
    interpolate: /\{\{=(.+?)\}\}/g,
    evaluate: /\{\{(.+?)\}\}/g
};

App.router = new App.Router;